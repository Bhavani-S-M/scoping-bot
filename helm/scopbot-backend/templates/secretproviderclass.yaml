apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-kv-sync
  namespace: {{ .Values.namespace }}
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: "{{ .Values.keyvault.clientId }}"  
    keyvaultName: "{{ .Values.keyvault.name }}"                 
    cloudName: ""                                               
    tenantId: "{{ .Values.keyvault.tenantId }}"                
    syncSecret: "true"                                         
    objects: |
      array:
        - |
          objectName: DATABASE-URL
          objectType: secret
        - |
          objectName: SECRET-KEY
          objectType: secret
        - |
          objectName: ALGORITHM
          objectType: secret
        - |
          objectName: ACCESS-TOKEN-EXPIRE-MINUTES
          objectType: secret
        - |
          objectName: REFRESH-TOKEN-EXPIRE-DAYS
          objectType: secret
        - |
          objectName: AZURE-OPENAI-ENDPOINT
          objectType: secret
        - |
          objectName: AZURE-OPENAI-KEY
          objectType: secret
        - |
          objectName: AZURE-OPENAI-VERSION
          objectType: secret
        - |
          objectName: AZURE-OPENAI-DEPLOYMENT
          objectType: secret
        - |
          objectName: AZURE-OPENAI-EMBEDDING-DEPLOYMENT
          objectType: secret
        - |
          objectName: AZURE-SEARCH-ENDPOINT
          objectType: secret
        - |
          objectName: AZURE-SEARCH-KEY
          objectType: secret
        - |
          objectName: AZURE-SEARCH-INDEX
          objectType: secret
        - |
          objectName: AZURE-STORAGE-ACCOUNT
          objectType: secret
        - |
          objectName: AZURE-STORAGE-KEY
          objectType: secret
        - |
          objectName: AZURE-STORAGE-CONTAINER
          objectType: secret
        - |
          objectName: SMTP-HOST
          objectType: secret
        - |
          objectName: SMTP-PORT
          objectType: secret
        - |
          objectName: SMTP-USER
          objectType: secret
        - |
          objectName: SMTP-PASS
          objectType: secret
        - |
          objectName: FRONTEND-URL
          objectType: secret

  secretObjects:
    - secretName: {{ .Values.envSecretName }}
      type: Opaque
      data:
        - objectName: DATABASE-URL
          key: DATABASE_URL
        - objectName: SECRET-KEY
          key: SECRET_KEY
        - objectName: ALGORITHM
          key: ALGORITHM
        - objectName: ACCESS-TOKEN-EXPIRE-MINUTES
          key: ACCESS_TOKEN_EXPIRE_MINUTES
        - objectName: REFRESH-TOKEN-EXPIRE-DAYS
          key: REFRESH_TOKEN_EXPIRE_DAYS
        - objectName: AZURE-OPENAI-ENDPOINT
          key: AZURE_OPENAI_ENDPOINT
        - objectName: AZURE-OPENAI-KEY
          key: AZURE_OPENAI_KEY
        - objectName: AZURE-OPENAI-VERSION
          key: AZURE_OPENAI_VERSION
        - objectName: AZURE-OPENAI-DEPLOYMENT
          key: AZURE_OPENAI_DEPLOYMENT
        - objectName: AZURE-OPENAI-EMBEDDING-DEPLOYMENT
          key: AZURE_OPENAI_EMBEDDING_DEPLOYMENT
        - objectName: AZURE-SEARCH-ENDPOINT
          key: AZURE_SEARCH_ENDPOINT
        - objectName: AZURE-SEARCH-KEY
          key: AZURE_SEARCH_KEY
        - objectName: AZURE-SEARCH-INDEX
          key: AZURE_SEARCH_INDEX
        - objectName: AZURE-STORAGE-ACCOUNT
          key: AZURE_STORAGE_ACCOUNT
        - objectName: AZURE-STORAGE-KEY
          key: AZURE_STORAGE_KEY
        - objectName: AZURE-STORAGE-CONTAINER
          key: AZURE_STORAGE_CONTAINER
        - objectName: SMTP-HOST
          key: SMTP_HOST
        - objectName: SMTP-PORT
          key: SMTP_PORT
        - objectName: SMTP-USER
          key: SMTP_USER
        - objectName: SMTP-PASS
          key: SMTP_PASS
        - objectName: FRONTEND-URL
          key: FRONTEND_URL
